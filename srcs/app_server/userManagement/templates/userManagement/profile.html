<!-- dwitter/templates/dwitter/profile.html -->

{% extends 'base.html' %}

{% block content %}

<div class="d-flex justify-content-center">
    <img class="rounded-circle profile-image" src="{{ user.profile.avatar.url }}" alt="Placeholder image">
</div>
<h2 class="text-center text-dark my-4 stylish-font"> 
    {{user.username}}'s Profile 
    {% if user.profile.logged_in is True  %}
        <span style="color: green; margin-left: 5px; font-size: 0.5em;">Online</span>
    {% else %}
        <span style="color: red; margin-left: 5px; font-size: 0.5em;">Offline</span>    
    {% endif %}
</h2>


<div class="container my-4">
    <div class="card">
        <div class="card-header text-center text-white bg-purple">
            <h4>Personal information</h4>
        </div>
        <div class="card-body">
            <div class="row justify-content-center">
                <div class="col-md-10">
                    <div class="table-responsive">
                        <table class="table table-hover">
                            <thead class>
                                <tr>
                                    <th class="text-center">Username</th>
                                    <th class="text-center">First Name</th>
                                    <th class="text-center">Last Name</th>
                                    <th class="text-center">Registration Date</th>
                                    <th class="text-center">Last Login</th>
                                    <th class="text-center">ID</th>
                                </tr>
                            </thead>
                            <tbody>
                                <tr>
                                    <td class="text-center">{{user.username}}</td>
                                    <td class="text-center">{{user.first_name}}</td>
                                    <td class="text-center">{{user.last_name}}</td>
                                    <td class="text-center">{{user.date_joined}}</td>
                                    <td class="text-center">{{user.last_login}}</td>
                                    <td class="text-center">{{user.id}}</td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<div class="container my-4">
    <div class="card">
        <div class="card-header text-center text-white bg-purple">
            <h4>Player Stats</h4>
        </div>
        <div class="card-body">
            <div class="row justify-content-center">
                <div class="col-md-10">
                    <div class="table-responsive">
                        <table class="table table-hover">
                            <thead class>
                                <tr>
                                    <th class="text-center">Total Games</th>
                                    <th class="text-center">Total Game Time</th>
                                    <th class="text-center">Total Tournaments</th>
                                    <th class="text-center">Best Tournament Rank</th>
                                    <th class="text-center">Total Hits</th>
                                    <th class="text-center">Total Misses</th>
                                </tr>
                            </thead>
                            <tbody>
                                <tr>
                                    <td class="text-center">{{ stats.totalGames }}</td>
                                    <td class="text-center">{{ stats.totalGameTime }}</td>
                                    <td class="text-center">{{ stats.totalTournaments }}</td>
                                    <td class="text-center">{{ stats.bestTournamentRank }}</td>
                                    <td class="text-center">{{ stats.totalHits }}</td>
                                    <td class="text-center">{{ stats.totalMisses }}</td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
<div class="d-flex justify-content-center">
    <div class="chart">
        <canvas id="winLossChart"></canvas>
    </div>
    <div class="chart">
        <canvas id="winLossChartTournament"></canvas>
    </div>
</div>

<div class="column">
    <div class="block">
        <h3 class="title is-4"><br>Stats:</h3>
        <div class="content">
            <div>
                <h4>Total Stats:</h4>
                <ul>
                    <li>Total Games: {{ stats.totalGames }}</li>
                    <li>Total Game Time: {{ stats.totalGameTime }}</li>
                    <li>Total Tournaments: {{ stats.totalTournaments }}</li>
                    <li>Won Tournaments: {{ stats.wonTournaments }}</li>
                    <li>Best Tournament Rank: {{ stats.bestTournamentRank }}</li>
                    <li>Total Misses: {{ stats.totalMisses }}</li>
                    <li>Total Hits: {{ stats.totalHits }}</li>
                    <li>Total Wins: {{ stats.totalWins }}</li>
                    <li>Total Defeats: {{ stats.totalDefeats }}</li>
                </ul>
            </div>
    
            <div>
                <h4>Game Type Stats:</h4>
                <div>
                    <h5>Local:</h5>
                    <ul>
                        <li>Longest Ball Rally: {{ stats.gameTypeStats.local.longestBallRally }}</li>
                        <li>AVG Points per game: {{ stats.gameTypeStats.local.averagePointsPerGame }}</li>
                        <li>Best game score: {{ stats.gameTypeStats.local.bestGameScore }}</li>
                        <li>Highest Winning Streak: {{ stats.gameTypeStats.local.highestWinningStreak }}</li>
                    </ul>
                </div>
    
                <div>
                    <h5>Remote:</h5>
                    <ul>
                        <li>Longest Ball Rally: {{ stats.gameTypeStats.remote.longestBallRally }}</li>
                        <li>AVG Points per game: {{ stats.gameTypeStats.remote.averagePointsPerGame }}</li>
                        <li>Best game score: {{ stats.gameTypeStats.remote.bestGameScore }}</li>
                        <li>Highest Winning Streak: {{ stats.gameTypeStats.remote.highestWinningStreak }}</li>
                    </ul>
                </div>
    
                <div>
                    <h5>AI:</h5>
                    <ul>
                        <li>Longest Ball Rally: {{ stats.gameTypeStats.ai.longestBallRally }}</li>
                        <li>AVG Points per game: {{ stats.gameTypeStats.ai.averagePointsPerGame }}</li>
                        <li>Best game score: {{ stats.gameTypeStats.ai.bestGameScore }}</li>
                        <li>Highest Winning Streak: {{ stats.gameTypeStats.ai.highestWinningStreak }}</li>
                    </ul>
                </div>
            </div>
        </div>
    </div>

     <!-- New section for All Games -->
     <div class="block">
        <h3 class="title is-4">All Games:</h3>
        <div class="content">
            <ul>
                <!-- Loop through all games and display relevant information -->
                {% for gld in stats.gameListData %}
                    <li><a href="/singleGameStats?gameID={{ gld.game.id }}&userID={{ gld.userGameStats.user.id }}"> {{ gld.game.matchName }} || {{ gld.game.matchDate }} || {{ gld.game.matchTime }} || against: {{ gld.opponentGameStats.user }}</a></li>
                {% endfor %}
            </ul>
        </div>
    </div>


<div class="column is-one-third">
    {% if user == request.user %}
    <div class="block">
        <form method="post" action="{% url 'userManagement:logout' %}">
			{% csrf_token %}
			<button type="submit">logout</button>
		</form>
    </div>
    {% endif %} 
    <div class="block">
		<a href="{% url 'userManagement:profile_list' %}">
            <button class="button is-dark is-outlined is-fullwidth">
                All Profiles
            </button>
        </a>
    </div>

    <div class="block">
        <h3 class="title is-4">
            {{user.username}} follows:
        </h3>
        <div class="content">
            <ul>
            {% for following in user.profile.follows.all %}
                <li>
                    <a href="{% url 'userManagement:profile' following.user.username %}">{{ following }}</a>
                </li>
            {% endfor %}
            </ul>
        </div>
    </div>

    <div class="block">
        <h3 class="title is-4">
            {{user.username}} is followed by:
        </h3>
        <div class="content">
            <ul>
            {% for follower in user.profile.followed_by.all %}
                <li>
                    <a href="{% url 'userManagement:profile' follower.user.username %}">{{ follower }}</a>
                </li>
            {% endfor %}
            </ul>
        </div>
    </div>

    <div class="block">
        {% if user == request.user %}
            <a href="{% url 'userManagement:update_profile' %}">Change Profile Picture</a>
        {% endif %} 
    <h1 class="title is-1">
        {{user.username}}'s Profile
        {% if user.profile.logged_in is True  %}
            <span style="color: green; margin-left: 5px; font-size: 0.5em;">Online</span>
        {% else %}
            <span style="color: red; margin-left: 5px; font-size: 0.5em;">Offline</span>    
        {% endif %}
    </h1>

    {% if user == request.user %}
            <a href="{% url 'userManagement:update_user' %}">Update Profile Info</a>
            <a href="{% url 'userManagement:change_password' %}">Change password</a>
        {% endif %} 
    </div>

    <!-- IMPORTANT !!!! -->
    {% if user != request.user %}
	<form method="post">
		{% csrf_token %}
		<div class="buttons has-addons">
		{% if user.profile in request.user.profile.follows.all %}
			<button class="button is-success is-static">Follow</button>
			<button class="button is-danger" name="follow" value="unfollow">Unfollow</button>
		{% else %}
			<button class="button is-success" name="follow" value="follow">Follow</button>
			<button class="button is-danger is-static">Unfollow</button>
		{% endif %}
		</div>
	</form>
    {% endif %} 

</div>

<script>
    var ctx = document.getElementById('winLossChart').getContext('2d');
    var ctx = document.getElementById('winLossChartTournament').getContext('2d');
    var chart = new Chart(ctx, {
        type: 'pie',
        data: {
            labels: ['Wins', 'Losses'],
            datasets: [{
                data: [{{ stats.totalWins }}, {{ stats.totalDefeats }}],
                backgroundColor: ['green', 'red'],
            }]
        },
        options: {
            responsive: true,
            title: {
                display: true,
                text: 'Win/Loss Ratio'
            }
        }
    });

</script>

{% endblock content %}