<!-- dwitter/templates/dwitter/profile.html -->

{% load static %}
{% block content %}

<div class="container">
    <div class="row">
        <!-- Column for profile picture -->
        <div class="col">
            <div class="d-flex justify-content-center">
                <img class="rounded-circle profile-image" src="{{ user.profile.avatar.url }}" alt="Placeholder image">
            </div>
        </div>

        <!-- Column for name and logged in status -->
        <div class="col">
            <h2 class="text-center my-4 stylish-font">
                {{user.username}}'s Profile
                {% if user.profile.logged_in is True  %}
                <span style="color: rgb(4, 177, 4); margin-left: 5px; font-size: 0.5em;">Online</span>
                {% else %}
                <span style="color: red; margin-left: 5px; font-size: 0.5em;">Offline</span>
                {% endif %}
            </h2>
        </div>

        <!-- Column for logout and all profiles buttons -->
        <div class="col">
            <div style="width: 200px; margin: 20px;">
                <!-- {% if user == request.user %}
                <form method="post" action="{% url 'userManagement:logout' %}">
                    {% csrf_token %}
                    <button type="submit" class="btn btn-danger btn-block">logout</button>
                </form>
                {% endif %}  -->
                <!-- <a href="{% url 'userManagement:profile_list' %}" class="btn btn-success btn-block">
                    All Profiles
                </a> -->
                <button type="button" class="btn buttonblue" id="allProfilesBtn">All Profiles</button>
            </div>
            {% if user != request.user %}
            <button class="button is-success is-static btn btn-success btn-block" id="followBtn">Follow</button>

            <div style="width: 200px; margin: 20px;">
                <form method="post">
                    {% csrf_token %}
                    <div class="buttons has-addons">
                        {% if user.profile in request.user.profile.follows.all %}
                        <button class="button is-success is-static btn btn-success btn-block">Follow</button>
                        <button class="button is-danger btn btn-danger btn-block" name="follow" value="unfollow">Unfollow</button>
                        {% else %}
                        <button class="button is-success btn btn-success btn-block" name="follow" value="follow">Follow</button>
                        <button class="button is-danger is-static btn btn-danger btn-block">Unfollow</button>
                        {% endif %}
                    </div>
                </form>
            </div>
            {% endif %}
        </div>
    </div>
</div>

<div class="container my-4">
    <div class="card">
        <div class="card-header text-center text-white bg-purple">
            <h4>Personal information</h4>
        </div>
        <div class="card-body">
            <div class="row justify-content-center">
                <div class="col-md-10">
                    <div class="table-responsive">
                        <table class="table table-hover">
                            <thead class>
                                <tr>
                                    <th class="text-center">Username</th>
                                    <th class="text-center">First Name</th>
                                    <th class="text-center">Last Name</th>
                                    <th class="text-center">Registration Date</th>
                                    <th class="text-center">Last Login</th>
                                    <th class="text-center">ID</th>
                                </tr>
                            </thead>
                            <tbody>
                                <tr>
                                    <td class="text-center">{{user.username}}</td>
                                    <td class="text-center">{{user.first_name}}</td>
                                    <td class="text-center">{{user.last_name}}</td>
                                    <td class="text-center">{{user.date_joined}}</td>
                                    <td class="text-center">{{user.last_login}}</td>
                                    <td class="text-center">{{user.id}}</td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<div class="container my-4">
    <div class="card">
        <div class="card-header text-center text-white bg-purple">
            <h4>Player Stats</h4>
        </div>
        <div class="card-body">
            <div class="row justify-content-center">
                <div class="col-md-10">
                    <div class="table-responsive">
                        <table class="table table-hover">
                            <thead class>
                                <tr>
                                    <th class="text-center">Total Games</th>
                                    <th class="text-center">Total Game Time</th>
                                    <th class="text-center">Total Tournaments</th>
                                    <th class="text-center">Best Tournament Rank</th>
                                    <th class="text-center">Total Hits</th>
                                    <th class="text-center">Total Misses</th>
                                </tr>
                            </thead>
                            <tbody>
                                <tr>
                                    <td class="text-center">{{ stats.totalGames }}</td>
                                    <td class="text-center">{{ stats.totalGameTime }}</td>
                                    <td class="text-center">{{ stats.totalTournaments }}</td>
                                    <td class="text-center">{{ stats.bestTournamentRank }}</td>
                                    <td class="text-center">{{ stats.totalHits }}</td>
                                    <td class="text-center">{{ stats.totalMisses }}</td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
            <div class="d-flex justify-content-center">
                {% if stats.totalGames != 0 %}
                <div class="chart">
                    <canvas id="winLossChart"></canvas>
                </div>
                {% endif %}
                {% if stats.totalTournaments != 0 %}
                <div class="chart">
                    <canvas id="winLossChartTournament"></canvas>
                </div>
                {% endif %}
            </div>
        </div>
</div>

<div class="container my-4">
    <div class="card">
        <div class="card-header text-center text-white bg-purple">
            <h4>Game Stats</h4>
            <div class="d-inline-block float-end">
                <button class="btn buttonblue" type="button" id="localGamesButton">
                    Local Games
                </button>
                <button class="btn buttonblue" type="button" id="remoteGamesButton">
                    Remote Games
                </button>
                <button class="btn buttonblue" type="button" id="aiGamesButton">
                    AI Games
                </button>
            </div>
        </div>
        <div class="card-body">
            <div class="row justify-content-center">
                <div class="col-md-10">
                    <div class="table-responsive">
                        <table class="table table-hover">
                            <thead class>
                                <tr>
                                    <th class="text-center">AVG Points Per Game</th>
                                    <th class="text-center">Best Game Score</th>
                                    <th class="text-center">Highest Winning Streak</th>
                                    <th class="text-center">Longest Ball Rally</th>
                                </tr>
                            </thead>
                                <tbody id="gameStats">
                                    <tr>
                                        <td class="text-center"></td>
                                        <td class="text-center"></td>
                                        <td class="text-center"></td>
                                        <td class="text-center"></td>
                                    </tr>
                                </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>


<div class="container my-4">
    <div class="card">
        <div class="card-header text-center text-white bg-purple">
            <h4>All Games</h4>
        </div>
        <div class="card-body">
            <div class="row justify-content-center">
                <div class="col-md-10">
                    <div class="table-responsive">
                        <table class="table table-hover">
                            <thead class>
                                <tr>
                                    <th class="text-center">ID</th>
                                    <th class="text-center">Date & Time</th>
                                    <th class="text-center">Opponent</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for gld in stats.gameListData %}
                                <tr>
                                    <td class="text-center">
                                      <button type="button"  class="btn buttonblue statsGameBtn" data-matchName="{{ gld.game.matchName }}" data-username="{{ gld.userGameStats.user.username }}">{{ gld.game.matchName }}</button>
                                    </td>

                                    <td class="text-center">{{ gld.game.matchDate }} {{ gld.game.matchTime }} </td>
                                    {% if gld.opponentGameStats.user != None %}
                                    <td class="text-center">
                                      <button type="button"  class="btn buttonblue profileBtn" data-opponent="{{ gld.opponentGameStats.user }}">{{ gld.opponentGameStats.user }}</button>
                                    </td>
                                    {% endif %}
                                    {% if gld.opponentGameStats.user == None %}
                                    <td class="text-center">Guest</td>
                                    {% endif %}
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<div class="container my-4">
    <div class="card">
        <div class="card-header text-center text-white bg-purple">
            <h4>All Tournaments</h4>
        </div>
        <div class="card-body">
            <div class="row justify-content-center">
                <div class="col-md-10">
                    <div class="table-responsive">
                        <table class="table table-hover">
                            <thead class>
                                <tr>
                                    <th class="text-center">ID</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for tm in stats.tournaments %}
                                <tr>
                                    <td class="text-center"><a href="/tournament_stats/{{ tm.tournament_id }}"> {{ tm.tournament_id }}</a></td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<div class="container my-4">
    <div class="card">
        <div class="card-header text-center text-white bg-purple">
            <h4>{{user.username}} follows</h4>
        </div>
        <div class="card-body">
            <div class="row justify-content-center">
                <div class="col-md-10">
                    <div class="table-responsive">
                        <table class="table table-hover">
                            <tbody>
                                {% for following in user.profile.follows.all %}
                                <tr>
                                    <td class="text-center"><a href="{% url 'userManagement:profile' following.user.username %}"></a>{{ following }}</a></td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<div class="container my-4">
    <div class="card">
        <div class="card-header text-center text-white bg-purple">
            <h4>{{user.username}} is followed by</h4>
        </div>
        <div class="card-body">
            <div class="row justify-content-center">
                <div class="col-md-10">
                    <div class="table-responsive">
                        <table class="table table-hover">
                            <tbody>
                                {% for follower in user.profile.followed_by.all %}
                                <tr>
                                    <td class="text-center"><a href="{% url 'userManagement:profile' follower.user.username %}">{{ follower }} </a></td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

{% if user == request.user %}
<div class="d-flex justify-content-center">
    <!-- <a href="{% url 'userManagement:update_profile' %}" class="btn btn-secondary" role="button" style="margin-right: 15px;">
        Change Profile Picture
    </a> -->
    <button type="button" class="btn buttonblue" id="profilePictureBtn">Change Profile Picture</button>
    <!-- <a href="{% url 'userManagement:update_user' %}" class="btn btn-secondary" role="button" style="margin-right: 15px;">
        Update Profile Info
    </a> -->
    <button type="button" class="btn buttonblue" id="updateProfileBtn">Update Profile Info</button>
    <!-- <a href="{% url 'userManagement:change_password' %}" class="btn btn-secondary" role="button">
        Change Password
    </a> -->
    <button type="button" class="btn buttonblue" id="passwordBtn">Change Password</button>
    {% endif %}
    <div id="modalContainer"></div>
  </div>
</div>
{% endblock %}
{% block extra_scripts %}
{% if user == request.user %}
<script>
document.getElementById("profilePictureBtn").addEventListener("click", function() {
    console.log("profilePictureBtn");
    renderForm("{% url 'userManagement:update_profile' %}", "profilePicture", "Change Profile Picture");
});
document.getElementById("updateProfileBtn").addEventListener("click", function() {
    console.log("updateProfileBtn");
    renderForm("{% url 'userManagement:update_user' %}", "updateProfile", "Update Profile Info");
});
document.getElementById("passwordBtn").addEventListener("click", function() {
    console.log("passwordBtn");
    renderForm("{% url 'userManagement:change_password' %}", "password", "Change Password");
});

function renderForm(url, containerId, title) {
console.log("triggered")
    fetch(url, {
    // Include CSRF token in the headers if includeCSRF is true
    headers: {
            "X-CSRFToken": getCookie("csrftoken")
        },
})
.then(response => response.text())
.then(html => {
  // Create a modal using the fetched HTML content
  const modalHtml = `
        <div class="modal fade" id="${containerId}Modal" tabindex="-1" role="dialog" aria-labelledby="${containerId}ModalLabel" aria-hidden="true">
            <div class="modal-dialog modal-dialog-scrollable" role="document">
                <div class="modal-content">
                    <div class="modal-header">
                        <h5 class="modal-title" id="${containerId}ModalLabel">${title}</h5>
                        <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                            <span aria-hidden="true">&times;</span>
                        </button>
                    </div>
                    <div class="modal-body text-center">
                        ${html} <!-- Render the fetched form here -->
                    </div>
                </div>
            </div>
        </div>
    `;
     // Add the modal HTML to the container
     document.getElementById("modalContainer").innerHTML = modalHtml;
      // Show the modal
      const modal = document.getElementById(`${containerId}Modal`);
      modal.classList.add('show');
      modal.style.display = 'block';

       // Add event listener to close modal when clicking on the cross (close button)
    const closeButton = modal.querySelector('.close');
    closeButton.addEventListener('click', function() {
        modal.style.display = 'none';
    });

    // Close modal when clicking outside of it
    window.addEventListener('click', function(event) {
        if (event.target === modal) {
            modal.style.display = 'none';
        }
    });
        // Find the form element within the modal
        const form = modal.querySelector("form");
        // Check if the form element was found
        if (form) {
            // Add the desired ID to the form element
            form.id = `${containerId}Form`;
            // Add event listener for form submission
            form.addEventListener("submit", function(event) {
                event.preventDefault(); // Prevent default form submission
                // Create FormData object using the form element
                const formData = new FormData(form);
                // Send POST request to register user
                console.log(url)
                fetch(url, {
                    method: "POST",
                    body: formData,
                    enctype: "multipart/form-data",
                    // Include CSRF token in the headers
                    headers: {
                        "X-CSRFToken": getCookie("csrftoken"),
                    }
                })
                .then(response => {
                    console.log(response);
                    if (!response.url.includes(url)) {
                        const modal = document.getElementById(`${containerId}Modal`);
                        modal.classList.remove('show');
                        modal.style.display = 'none';
                        if (containerId == 'profilePicture' || containerId == 'updateProfile'){
                            reloadProfilePage();
                        }
                    } else {
                        // Login failed
                        // Display error message
                        response.text().then(errorMessage => {
                        var extractedMessage = extractErrorMessage(errorMessage);
                        const modal = document.getElementById(`${containerId}Modal`);
                        const errorContainer = document.createElement("div");
                        errorContainer.classList.add("alert", "alert-danger");
                        errorContainer.textContent = extractedMessage;
                        modal.querySelector(".modal-body").appendChild(errorContainer);
                    });
                }})
                .catch(error => console.error('Error:', error));
                });
                        } else {
                            console.error("Form element not found in fetched HTML content");
                        }
                    })
                    .catch(error => console.error('Error fetching form:', error));
                }

            </script>
            {% endif %}
        <script src="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/js/bootstrap.min.js"></script>

<script>

  document.querySelectorAll(".profileBtn").forEach(button => {
        button.addEventListener("click", function() {
            console.log("profileOtherBtn clicked");
            // Fetch the profile page for the specific user associated with the clicked button
            const opponent = this.dataset.opponent; // Retrieve username from data attribute
            console.log(opponent);
            const url = `/profile/${opponent}/`; // Construct the URL with the username
            fetch(url)
            .then(response => response.text())
         .then(html => {
             document.getElementById("content").innerHTML = '';
             document.getElementById("content").innerHTML = html;
             executeJavaScriptInContent(html);
             })
             .catch(error => console.error('Error loading profiles page:', error));
     });
});
    document.getElementById("allProfilesBtn").addEventListener("click", function() {
        console.log("allProfilesBtn");
        fetch("{% url 'userManagement:profile_list' %}")
        .then(response => response.text())
        .then(html => {
            document.getElementById("content").innerHTML = '';
            document.getElementById("content").innerHTML = html;
            executeJavaScriptInContent(html);
            })
            .catch(error => console.error('Error loading profiles page:', error));
    });
    document.querySelectorAll(".statsGameBtn").forEach(button => {
        button.addEventListener("click", function() {
            console.log("statsGameBtn clicked");
            // Fetch the profile page for the specific user associated with the clicked button
            const username = this.dataset.username;
            console.log(username);
            const matchName = this.dataset.matchname;
            console.log(matchName);
            const url = `/singleGameStats?matchName=${matchName}&username=${username}/`;
            renderForm(url, "StatsGame", "Game stats");
           });
      });


function reloadProfilePage() {
  console.log("loading")
        document.getElementById("content").innerHTML = '';
        fetch("/profile")
            .then(response => response.text())
            .then(html => {
                // Replace the content of the main container with the logged-in content
                document.getElementById("content").innerHTML = html;
                executeJavaScriptInContent(html);
            })
            .catch(error => console.error('Error loading logged-in content:', error));
    }




// Function to extract the error message from the provided HTML
function extractErrorMessage(errorMessage) {
    // Create a temporary div element to hold the HTML
    var tempDiv = document.createElement('div');
    // Set the inner HTML of the temporary div to the provided errorMessage
    tempDiv.innerHTML = errorMessage;
    // Find the error message element
    var errorList = tempDiv.querySelector('.errorlist');
    // Check if the error message element exists
    if (errorList) {
        // Find the error message within the error list
        var errorMessageText = errorList.querySelector('li').textContent;
        // Return the error message
        return errorMessageText;
    } else {
        // Return null if no error message is found
        return null;
    }
}

    // this will only work while the js is not a separate file
    var chartElement = document.getElementById('winLossChart');
    if (chartElement !== null)
    {
        var ctx = chartElement  .getContext('2d');
        var chart = new Chart(ctx, {
            type: 'pie',
            data: {
                labels: ['Wins', 'Losses'],
                datasets: [{
                    data: [{{ stats.totalWins }}, {{ stats.totalDefeats }}],
                    backgroundColor: ['green', 'red'],
                }] // workaround would be reading the data from the html element
            },
            options: {
                responsive: true,
                plugins: {
                    title: {
                        display: true,
                        text: 'Games Win/Loss Ratio'
                    }
                }
            }
        });
    }

    var chartElement2 = document.getElementById('winLossChartTournament');
    if (chartElement2 !== null)
    {
        var ctx2 = chartElement2.getContext('2d');
        var chart2 = new Chart(ctx2, {
            type: 'pie',
            data: {
                labels: ['Wins', 'Losses'],
                datasets: [{
                    data: [{{ stats.wonTournaments }}, {{ stats.totalTournaments|add:'-wonTournaments' }}],
                    backgroundColor: ['green', 'red'],
                }]
            },
            options: {
                responsive: true,
                plugins: {
                    title: {
                        display: true,
                        text: 'Tournaments Win/Loss Ratio'
                    }
                }
            }
        });
    }

    var localAveragePointsPerGame = {{ stats.gameTypeStats.local.averagePointsPerGame }};
    var localBestGameScore = {{ stats.gameTypeStats.local.bestGameScore }};
    var localHighestWinningStreak = {{ stats.gameTypeStats.local.highestWinningStreak }};
    var localLongestBallRally = {{ stats.gameTypeStats.local.longestBallRally }};

    var remoteAveragePointsPerGame = {{ stats.gameTypeStats.remote.averagePointsPerGame }};
    var remoteBestGameScore = {{ stats.gameTypeStats.remote.bestGameScore }};
    var remoteHighestWinningStreak = {{ stats.gameTypeStats.remote.highestWinningStreak }};
    var remoteLongestBallRally = {{ stats.gameTypeStats.remote.longestBallRally }};


    var aiAveragePointsPerGame = {{ stats.gameTypeStats.ai.averagePointsPerGame }};
    var aiBestGameScore = {{ stats.gameTypeStats.ai.bestGameScore }};
    var aiHighestWinningStreak = {{ stats.gameTypeStats.ai.highestWinningStreak }};
    var aiLongestBallRally = {{ stats.gameTypeStats.ai.longestBallRally }};

    function setTableData(averagePointsPerGame, bestGameScore, highestWinningStreak, longestBallRally) {
        // Get the table body
        var tbody = document.getElementById('gameStats');

        // Get all the td elements in the tbody
        var tds = tbody.getElementsByTagName('td');

        // Set the content of the td elements
        tds[0].textContent = averagePointsPerGame;
        tds[1].textContent = bestGameScore;
        tds[2].textContent = highestWinningStreak;
        tds[3].textContent = longestBallRally;
    }

    setTableData(localAveragePointsPerGame, localBestGameScore, localHighestWinningStreak, localLongestBallRally);

    document.getElementById('localGamesButton').addEventListener('click', function() {
        console.log("localGames");
        setTableData(localAveragePointsPerGame, localBestGameScore, localHighestWinningStreak, localLongestBallRally);
    });

    document.getElementById('remoteGamesButton').addEventListener('click', function() {
        console.log("remoteGames");
        setTableData(remoteAveragePointsPerGame, remoteBestGameScore, remoteHighestWinningStreak, remoteLongestBallRally);
    });

    document.getElementById('aiGamesButton').addEventListener('click', function() {
        console.log("aiGames");
        setTableData(aiAveragePointsPerGame, aiBestGameScore, aiHighestWinningStreak, aiLongestBallRally);
    });
</script>
{% endblock %}
