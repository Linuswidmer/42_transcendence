{% extends 'pong/home.html' %}
{% load static %}
{% load socialaccount %}

{% block title %}
{% if not user.is_authenticated %}
Welcome Stranger
{% endif %}
{% endblock %}

{% block content %}
{% if not user.is_authenticated %}
    <h1>Welcome Stranger</h1>
<div class="container">
  <div class="image-container">
    <img src="{% static 'pong/michael.jpg' %}" alt="Image description">
  </div>
    <div>
        <!-- Content for non-authenticated users -->
      <button type="button" class="button" id="loginBtn">Login</button>
      <button type="button" class="button" id="registerBtn">Register</button>
      <button type="button" class="button" id="guestBtn">Continue as Guest</button>
      <button type="button" class="button" id="42Btn">Sign In with 42</button>
    </div>
  </div>

{% endif %}
{% endblock %}
  <script>
    // Event listeners for each button
    document.getElementById("loginBtn").addEventListener("click", function() {
        console.log("loginbtn");
        renderForm("{% url 'userManagement:login' %}", "loginModal");
    });
    document.getElementById("registerBtn").addEventListener("click", function() {
        console.log("registerbtn");
        renderForm("{% url 'userManagement:register_user' %}", "registerModal");
    });
    document.getElementById("guestBtn").addEventListener("click", function() {
        console.log("guestbtn");
        renderForm("{% url 'userManagement:register_guest' %}", "guestModal");
    });
    document.getElementById("42Btn").addEventListener("click", function() {
        console.log("42btn");
        window.location.href = "{% provider_login_url 'provider' %}";
    });

    // Function to fetch and render forms
    function renderForm(url, containerId) {
    console.log("triggered")
        fetch(url, {
        // Include CSRF token in the headers if includeCSRF is true
        headers: {
                "X-CSRFToken": getCookie("csrftoken")
            },
    })
    .then(response => response.text())
    .then(html => {
      // Create a modal using the fetched HTML content
      const modalHtml = `
            <div class="modal fade" id="${containerId}Modal" tabindex="-1" role="dialog" aria-labelledby="${containerId}ModalLabel" aria-hidden="true">
                <div class="modal-dialog" role="document">
                    <div class="modal-content">
                        <div class="modal-header">
                            <h5 class="modal-title" id="${containerId}ModalLabel"></h5>
                            <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                                <span aria-hidden="true">&times;</span>
                            </button>
                        </div>
                        <div class="modal-body">
                            ${html} <!-- Render the fetched form here -->
                        </div>
                    </div>
                </div>
            </div>
        `;
         // Add the modal HTML to the container
         document.getElementById("modalContainer").innerHTML = modalHtml;

          // Show the modal
          const modal = document.getElementById(`${containerId}Modal`);
          modal.classList.add('show');
          modal.style.display = 'block';
            
           // Add event listener to close modal when clicking on the cross (close button)
        const closeButton = modal.querySelector('.close');
        closeButton.addEventListener('click', function() {
            modal.style.display = 'none';
        });

        // Close modal when clicking outside of it
        window.addEventListener('click', function(event) {
            if (event.target === modal) {
                modal.style.display = 'none';
            }
        });

          // Find the form element within the modal
          const form = modal.querySelector("form");
            // Check if the form element was found
            if (form) {
                // Add the desired ID to the form element
                form.id = `${containerId}Form`;

                // Add event listener for form submission
                form.addEventListener("submit", function(event) {
                    event.preventDefault(); // Prevent default form submission

                    // Create FormData object using the form element
                    const formData = new FormData(form);

                    // Send POST request to register user
                    
                    fetch(url, {
        // Add event listener for form submission

        //const form = document.getElementById(`${containerId}Form`);
         //   console.log(containerId);
          //form.addEventListener("submit", function(event) {
            //event.preventDefault(); // Prevent default form submission

            // Serialize form data
           // const formData = new FormData(form);

            // Send POST request to register user
           // fetch(url, {
                method: "POST",
                body: formData,
                // Include CSRF token in the headers
                headers: {
                    "X-CSRFToken": getCookie("csrftoken"),
                }
            })
            .then(response => {
                console.log(response);
                if (response.ok) {
                    
                    console.log("Login successful");
                    const modal = document.getElementById(`${containerId}Modal`);
                    modal.classList.remove('show');
                    modal.style.display = 'none';
                    loadLoggedInContent();

                } else {
                    // Login failed
                    // Display error message
                    console.error("Login failed");
                    const errorMessage = data.error || "Login failed. Please check your credentials.";
                    const errorContainer = document.createElement("div");
                    errorContainer.classList.add("alert", "alert-danger");
                    errorContainer.textContent = errorMessage;
                    modal.querySelector(".modal-body").appendChild(errorContainer);
                }
            })
            .catch(error => console.error('Error:', error));
            });
                    } else {
                        console.error("Form element not found in fetched HTML content");
                    }
                })
                .catch(error => console.error('Error fetching form:', error));
            }

// Function to retrieve CSRF token from cookies
function getCookie(name) {
    let cookieValue = null;
    if (document.cookie && document.cookie !== '') {
        const cookies = document.cookie.split(';');
        for (let i = 0; i < cookies.length; i++) {
            const cookie = cookies[i].trim();
            // Does this cookie string begin with the name we want?
            if (cookie.substring(0, name.length + 1) === (name + '=')) {
                cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                break;
            }
        }
    }
    return cookieValue;
}
const csrftoken = getCookie('csrftoken');
</script>

