<!DOCTYPE html>
{% load static %}
{% load socialaccount %}
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Landing Page App</title>
    <link rel="stylesheet" type="text/css" href="{% static 'pong/styles.css' %}">
    <link href="https://maxcdn.bootstrapcdn.com/bootstrap/4.5.2/css/bootstrap.min.css" rel="stylesheet">
    <link rel="icon" type="image/x-icon" href="data:image/x-icon;,">
</head>
<body>
  <div class="container">
    <div class="image-container">
      <img src="{% static 'pong/michael.jpg' %}" alt="Image description">
    </div>
    <h1>Welcome to Pong</h1>
    <div id="content">
        <!-- Content for non-authenticated users -->
      <button type="button" class="button" id="loginBtn">Login</button>
      <button type="button" class="button" id="registerBtn">Register</button>
      <button type="button" class="button" id="guestBtn">Continue as Guest</button>
      <button type="button" class="button" id="42Btn">Sign In with 42</button>
    </div>
    <div id="modalContainer">

    </div>
  </div>

  <script>
    // Wait for the DOM content to be fully loaded
    document.addEventListener("DOMContentLoaded", function() {
    // Event listeners for each button
    document.getElementById("loginBtn").addEventListener("click", function() {
       renderForm("{% url 'userManagement:login' %}", "loginModalContainer", true, "cors");
    });

    document.getElementById("registerBtn").addEventListener("click", function() {
        renderForm("{% url 'userManagement:register_user' %}", "registerModalContainer", true, "cors");
    });

    document.getElementById("guestBtn").addEventListener("click", function() {
        renderForm("{% url 'userManagement:register_guest' %}", "guestModalContainer", true, "cors");
    });

    document.getElementById("42Btn").addEventListener("click", function() {
        renderForm("{% provider_login_url 'provider' %}", "oauth2ModalContainer", false, "no-cors");
    });

    // Function to fetch and render forms
    function renderForm(url, containerId, includeCSRF, mode) {
    console.log("triggered"),
    fetch(url, {
        // Include CSRF token in the headers if includeCSRF is true
        headers: includeCSRF ? {
                "X-CSRFToken": getCookie("csrftoken")
            } : {},
        mode: mode
    })
    .then(response => response.text())
    .then(html => {
      // Create a modal using the fetched HTML content
      const modalHtml = `
            <div class="modal fade" id="${containerId}Modal" tabindex="-1" role="dialog" aria-labelledby="${containerId}ModalLabel" aria-hidden="true">
                <div class="modal-dialog" role="document">
                    <div class="modal-content">
                        <div class="modal-header">
                            <h5 class="modal-title" id="${containerId}ModalLabel"></h5>
                            <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                                <span aria-hidden="true">&times;</span>
                            </button>
                        </div>
                        <div class="modal-body">
                            ${html} <!-- Render the fetched form here -->
                        </div>
                    </div>
                </div>
            </div>
        `;
         // Add the modal HTML to the container
         document.getElementById("modalContainer").innerHTML = modalHtml;

          // Show the modal
          const modal = document.getElementById(`${containerId}Modal`);
          modal.classList.add('show');
          modal.style.display = 'block';

          // Find the form element within the modal
          const form = modal.querySelector("form");
            // Check if the form element was found
            if (form) {
                // Add the desired ID to the form element
                form.id = `${containerId}Form`;

                // Add event listener for form submission
                form.addEventListener("submit", function(event) {
                    event.preventDefault(); // Prevent default form submission

                    // Create FormData object using the form element
                    const formData = new FormData(form);

                    // Send POST request to register user
                    fetch(url, {


        // Add event listener for form submission
        //const form = document.getElementById(`${containerId}Form`);
         //   console.log(containerId);
          //form.addEventListener("submit", function(event) {
            //event.preventDefault(); // Prevent default form submission

            // Serialize form data
           // const formData = new FormData(form);

            // Send POST request to register user
           // fetch(url, {
                method: "POST",
                body: formData,
                // Include CSRF token in the headers
                headers: {
                    "X-CSRFToken": getCookie("csrftoken"),

                }
            })
            .then(response => {
                if (response.ok) {
                    // Registration successful
                    // Handle success (e.g., redirect user)
                    console.log("Registration successful");
                    const modal = document.getElementById(`${containerId}Modal`);
                    modal.classList.remove('show');
                    modal.style.display = 'none';
                } else {
                    // Registration failed
                    // Handle error (e.g., display error message)
                    console.error("Registration failed");
                }

            })
            .catch(error => {
                console.error("Error:", error);
            });
        });
      } else {
                console.error("Form element not found in fetched HTML content");
            }
    })
    .catch(error => console.error('Error fetching form:', error));
}
});
// Function to retrieve CSRF token from cookies
function getCookie(name) {
    let cookieValue = null;
    if (document.cookie && document.cookie !== '') {
        const cookies = document.cookie.split(';');
        for (let i = 0; i < cookies.length; i++) {
            const cookie = cookies[i].trim();
            // Does this cookie string begin with the name we want?
            if (cookie.substring(0, name.length + 1) === (name + '=')) {
                cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                break;
            }
        }
    }
    return cookieValue;
}
const csrftoken = getCookie('csrftoken');
</script>
</body>
</html>
